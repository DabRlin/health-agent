# HealthAI 系统架构设计文档

> 版本: 1.0  
> 更新日期: 2024-12-06

---

## 一、系统概述

HealthAI 是一个基于 AI 的个人健康风险预测与智能健康咨询系统。系统通过整合多维度健康数据，构建用户健康画像，提供个性化的健康管理服务。

### 核心理念

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户健康画像                              │
├─────────────────┬─────────────────┬─────────────────────────────┤
│    智能问诊      │   体检报告分析   │      健康数据分析            │
│   (Dify LLM)    │  (多模态/OCR)   │      (ML/DL 模型)           │
├─────────────────┼─────────────────┼─────────────────────────────┤
│ • 症状描述       │ • PDF/图片上传  │ • 智能穿戴设备数据           │
│ • 对话式诊断     │ • OCR 文字提取  │ • 手动录入指标              │
│ • 健康建议       │ • 指标解读      │ • 趋势分析                  │
│                 │ • 异常预警      │ • 风险预测                  │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

---

## 二、功能模块

### 2.1 智能问诊模块

**技术方案**: Dify 工作流 + 大语言模型

**功能描述**:
- 用户通过自然语言描述症状
- AI 进行多轮对话式问诊
- 基于症状给出初步健康建议
- 必要时建议就医

**数据流**:
```
用户输入 → Dify API → LLM 推理 → 流式响应 → 前端展示
```

### 2.2 体检报告分析模块

**技术方案**: OCR + LLM 工作流

**功能描述**:
- 支持 PDF/图片格式的体检报告上传
- OCR 提取报告中的文字和数据
- LLM 解读各项指标含义
- 标注异常项并给出建议

**技术选型**:
| 组件 | 候选方案 | 说明 |
|-----|---------|------|
| OCR | PaddleOCR / Tesseract | 开源、中文支持好 |
| 多模态 | GPT-4V / Qwen-VL | 直接理解图片 |
| 文本分析 | Dify 工作流 | 结构化解读 |

**数据流**:
```
上传报告 → OCR/多模态提取 → 结构化数据 → LLM 解读 → 存储 + 展示
```

### 2.3 健康数据分析模块

**技术方案**: ML/DL 模型 + 时序分析

**功能描述**:
- 接入智能穿戴设备数据
- 支持手动录入健康指标
- 健康趋势可视化
- 疾病风险预测

**子功能**:
1. **数据采集**: 穿戴设备同步、手动录入
2. **趋势分析**: 时序图表、周期性分析
3. **风险预测**: ML 模型评估疾病风险
4. **异常检测**: 实时监测指标异常

---

## 三、数据需求分析

### 3.1 疾病风险预测所需数据

| 风险类型 | 必需数据 | 可选数据 | 数据来源 |
|---------|---------|---------|---------|
| **心血管疾病** | 年龄、性别、血压、总胆固醇、HDL、BMI | 吸烟史、家族史、是否服用降压药 | 体检报告 + 手动录入 |
| **糖尿病** | 年龄、BMI、腰围、空腹血糖 | 糖化血红蛋白、家族史、运动习惯 | 体检报告 + 穿戴设备 |
| **代谢综合征** | 腰围、血压、空腹血糖、甘油三酯、HDL | 体重变化趋势 | 体检报告 |
| **睡眠障碍** | 睡眠时长、入睡时间、觉醒次数 | 心率变异性、血氧饱和度 | 穿戴设备 |
| **骨质疏松** | 年龄、性别、体重、身高 | 钙摄入、运动量、骨密度 | 手动录入 + 体检 |

### 3.2 健康趋势分析所需数据

| 数据类型 | 采集频率 | 来源 | 分析目标 |
|---------|---------|------|---------|
| **心率** | 实时/每分钟 | 穿戴设备 | 心率变异性(HRV)、异常检测、运动强度 |
| **血压** | 每日 1-2 次 | 手动/血压计 | 趋势预测、高血压预警 |
| **血糖** | 每日 1-3 次 | 手动/CGM | 波动分析、饮食关联 |
| **睡眠** | 每晚 | 穿戴设备 | 质量评分、睡眠周期分析 |
| **步数** | 每日累计 | 穿戴设备 | 活动量评估、久坐提醒 |
| **体重** | 每日/每周 | 手动/体脂秤 | 趋势预测、目标追踪 |
| **血氧** | 实时/睡眠时 | 穿戴设备 | 呼吸暂停检测 |

### 3.3 数据采集周期建议

```
实时数据（穿戴设备）:
├── 心率: 每分钟采样
├── 血氧: 每 5 分钟采样
└── 运动: 实时计步

定期数据（手动/设备）:
├── 血压: 每日早晚各一次
├── 血糖: 餐前餐后
├── 体重: 每日晨起
└── 睡眠: 每晚自动记录

低频数据（体检报告）:
├── 血常规: 每年 1-2 次
├── 生化指标: 每年 1-2 次
└── 影像检查: 按需
```

---

## 四、ML 模型方案

### 4.1 风险评估模型

#### 心血管疾病风险 - Framingham Risk Score

经典的心血管风险评估公式，基于 Framingham 心脏研究。

**输入参数**:
- 年龄 (30-79 岁)
- 性别
- 总胆固醇 (mg/dL)
- HDL 胆固醇 (mg/dL)
- 收缩压 (mmHg)
- 是否服用降压药
- 是否吸烟
- 是否有糖尿病

**输出**: 10 年内心血管事件风险概率 (%)

**风险等级**:
- 低风险: < 10%
- 中风险: 10-20%
- 高风险: > 20%

#### 糖尿病风险 - FINDRISC 评分

芬兰糖尿病风险评分，用于评估 2 型糖尿病风险。

**输入参数**:
- 年龄
- BMI
- 腰围
- 是否服用降压药
- 是否有高血糖史
- 是否每天运动
- 是否每天吃蔬果
- 家族糖尿病史

**输出**: 风险评分 (0-26 分)

**风险等级**:
- 低风险: < 7 分
- 轻度风险: 7-11 分
- 中度风险: 12-14 分
- 高风险: 15-20 分
- 极高风险: > 20 分

### 4.2 趋势预测模型

| 任务 | 模型 | 输入 | 输出 |
|-----|------|------|------|
| 血压趋势预测 | ARIMA / Prophet | 历史血压序列 | 未来 7 天预测 |
| 血糖波动分析 | LSTM | 血糖 + 饮食 + 运动 | 餐后血糖预测 |
| 体重趋势 | 线性回归 / Prophet | 历史体重 | 目标达成预测 |

### 4.3 异常检测模型

| 任务 | 模型 | 说明 |
|-----|------|------|
| 心率异常 | Isolation Forest | 检测异常心率模式 |
| 睡眠异常 | Autoencoder | 检测异常睡眠模式 |
| 综合异常 | One-Class SVM | 多指标联合异常检测 |

### 4.4 模型实现路径

```
阶段一: 基于公式的评估（当前优先）
├── Framingham 心血管风险公式
├── FINDRISC 糖尿病风险评分
└── 代谢综合征诊断标准

阶段二: 传统 ML 模型
├── scikit-learn 分类/回归
├── 特征工程
└── 模型训练与评估

阶段三: 深度学习模型
├── LSTM 时序预测
├── Transformer 健康序列建模
└── 多模态融合
```

---

## 五、智能穿戴设备数据方案

### 5.1 模拟设备方案

为验证完整数据流，建议模拟智能穿戴设备数据源。

**模拟数据类型**:
- 心率 (60-100 bpm，运动时更高)
- 步数 (每日累计)
- 睡眠 (入睡时间、觉醒次数、睡眠阶段)
- 血氧 (95-100%)

**模拟脚本功能**:
```python
# 伪代码示例
class DeviceSimulator:
    def generate_heart_rate(self):
        # 基于时间生成合理的心率数据
        # 白天活动时较高，夜间睡眠时较低
        pass
    
    def generate_sleep_data(self):
        # 生成睡眠周期数据
        # 包含浅睡、深睡、REM 阶段
        pass
    
    def generate_steps(self):
        # 生成每日步数
        # 符合正常人活动规律
        pass
```

### 5.2 数据存储方案

#### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| **SQLite** | 简单、无需部署、当前已用 | 不适合高并发写入 | MVP 演示 ✅ |
| **PostgreSQL + TimescaleDB** | 专业时序扩展、SQL 兼容 | 需要额外部署 | 生产环境 |
| **InfluxDB** | 专为时序设计、高性能 | 学习成本、独立系统 | IoT 专用 |
| **Redis** | 极快、适合实时缓存 | 内存限制、非持久化 | 实时数据缓存层 |
| **MongoDB** | Schema 灵活、JSON 原生 | 时序查询性能一般 | 非结构化数据 |

#### 推荐方案（MVP 阶段）

继续使用 **SQLite**，设计专门的时序数据表：

```sql
-- 穿戴设备原始数据（高频采集）
CREATE TABLE device_readings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    device_type VARCHAR(20),      -- 'smartwatch', 'band', 'scale'
    metric_type VARCHAR(30),      -- 'heart_rate', 'steps', 'sleep', 'spo2'
    value REAL,
    unit VARCHAR(10),
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    raw_data JSON,                -- 保留原始 JSON
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建索引优化查询
CREATE INDEX idx_device_readings_user_time 
ON device_readings(user_id, recorded_at);

CREATE INDEX idx_device_readings_type 
ON device_readings(metric_type, recorded_at);

-- 每日健康汇总（用于分析和展示）
CREATE TABLE daily_health_summary (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    date DATE NOT NULL,
    
    -- 心率统计
    avg_heart_rate REAL,
    min_heart_rate REAL,
    max_heart_rate REAL,
    resting_heart_rate REAL,
    
    -- 活动统计
    total_steps INTEGER,
    active_minutes INTEGER,
    calories_burned REAL,
    
    -- 睡眠统计
    sleep_duration REAL,          -- 小时
    sleep_quality_score INTEGER,  -- 0-100
    deep_sleep_duration REAL,
    light_sleep_duration REAL,
    rem_duration REAL,
    awake_count INTEGER,
    
    -- 其他指标
    avg_spo2 REAL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, date)
);
```

### 5.3 数据流架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  模拟穿戴设备    │────▶│   原始数据表     │────▶│   聚合服务      │
│  (Python 脚本)  │     │ device_readings │     │  (定时任务)     │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   前端展示       │◀────│    ML 模型      │◀────│   每日汇总表    │
│   趋势图表      │     │   风险预测      │     │ daily_summary  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

---

## 六、开发路线图

### Phase 1: 数据基础建设（1-2 周）

- [ ] 设计并创建穿戴设备数据表
- [ ] 实现模拟数据生成脚本
- [ ] 创建数据聚合服务（每日汇总）
- [ ] 扩展现有 API 支持新数据类型

**产出**: 完整的健康数据采集和存储链路

### Phase 2: ML 模型集成（2-3 周）

- [ ] 实现 Framingham 心血管风险评估
- [ ] 实现 FINDRISC 糖尿病风险评分
- [ ] 实现代谢综合征风险评估
- [ ] 替换当前的随机模拟数据
- [ ] 添加风险因素详细解读

**产出**: 基于真实算法的风险评估功能

### Phase 3: 趋势分析功能（1-2 周）

- [ ] 实现血压趋势预测（Prophet/ARIMA）
- [ ] 实现健康指标异常检测
- [ ] 前端趋势图表增强
- [ ] 添加预测结果展示

**产出**: 智能健康趋势分析功能

### Phase 4: 体检报告分析（2 周）

- [ ] 实现 PDF/图片上传接口
- [ ] 集成 OCR 服务（PaddleOCR）
- [ ] 设计报告解读 Dify 工作流
- [ ] 实现报告存储和展示

**产出**: 体检报告智能解读功能

### Phase 5: 健康画像整合（1 周）

- [ ] 整合三大模块数据
- [ ] 设计综合健康评分算法
- [ ] 实现健康画像可视化
- [ ] 生成个性化健康建议

**产出**: 完整的用户健康画像

---

## 七、技术栈总结

### 当前技术栈

| 层级 | 技术 |
|-----|------|
| 前端 | Vue 3 + Vite + ECharts |
| 后端 | Flask + SQLAlchemy |
| 数据库 | SQLite |
| AI 问诊 | Dify + LLM |
| 认证 | JWT |

### 计划扩展

| 功能 | 技术 |
|-----|------|
| OCR | PaddleOCR / Tesseract |
| ML 模型 | scikit-learn / PyTorch |
| 时序预测 | Prophet / statsmodels |
| 任务调度 | APScheduler |

---

## 八、附录

### A. 参考资料

1. Framingham Heart Study: https://framinghamheartstudy.org/
2. FINDRISC: https://www.diabetes.fi/english
3. Prophet: https://facebook.github.io/prophet/
4. PaddleOCR: https://github.com/PaddlePaddle/PaddleOCR

### B. 相关文档

- [API 接口文档](./API.md)
- [数据库设计文档](./DATABASE.md)
- [更新日志](./CHANGELOG.md)
